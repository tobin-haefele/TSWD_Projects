---
title : "Unhoused Funding Data Report"
author : "Tobin Haefele"
output:
  html_document:
    toc: true
---
## Introduction

In this report we partnered with the city of Missoula's "Community Planning, Development, and Innovation" (CPDI) department, specifically with the Community Development Division. In an effort to understand and monitor Missoula's unhoused population the CPDI department joined the Homeless Management Information System (HMIS) data collection effort by establishing a coordinated entry system. This allowed them to build datasets that can tell us much about the unhoused population. Along with this they have also executed a survey of the unhoused population to provide further data for us. Thanks to their hard work we have data to analyze and report on.

## Executive summary

The purpose of this report is to analyze the data provided by the CPDI department and provide a report on the findings. The report concluded with the following findings:

* Total amount spent, prevention vs currently homeless

* Funding sources and distribution of funding

* Demographics

```{r setup, echo=FALSE} 
knitr::opts_chunk$set(echo = FALSE)

```
  
```{r library, echo=FALSE, results='hide', message=FALSE}

# Load libraries
library(tidyverse)
library(lubridate)
library(ggplot2)
library(scales)
library(rmarkdown)
library(knitr)

#load data
X20231122_solutions_fund <- read.csv("C:/Users/thaef/OneDrive/Documents/GitHub/TSWD_Projects/Missoula_Unhoused/20231122-solutions-fund.csv")


```

### Analyzing the utilization of the housing solutions fund by prevention or currently homeless
Our first analysis is how the housing solutions fund is being utilized to help the unhoused population. We will look at the total amounnt of money spent on prevention and the total amount spent on those who are currently homeless. Along with this we also want to look at what the funding is being used for and how much is being used in each category.

Initial analysis of the housing solutions fund found that a total of $193,628 was put towards either prevention or assistance to those currently unhoused. Of this total around 77% of the funding is being used for prevention of homelessness compared to 23% being allocated for those who are currently homeless. This disparity could be explained by the fact that it is much cheaper to prevent homelessness than it is to assist those who are currently homeless. This also aligns with the CPDI's goal of preventing homelessness before it happens.

```{r, echo=FALSE, results='hide'}

#load data
solutions_fund <- X20231122_solutions_fund

#check data
head(solutions_fund)

#check data types
str(solutions_fund)

#summary statistics
summary(solutions_fund)

#convert to numeric
solutions_fund$Total.paid <- as.numeric(gsub("[\\$,]", "", solutions_fund$Total.paid))

# Calculate Total.paid and Percent.of.Total
summary_data <- solutions_fund %>%
  group_by(Prevention.or.Literally.Homeless) %>%
  summarize(Total.paid = sum(Total.paid)) %>%
  mutate(Percent.of.Total = Total.paid / sum(Total.paid)) %>%
  mutate(Percent.of.Total = scales::percent(Percent.of.Total))
print(summary_data)
print(sum(summary_data$Total.paid))


# Create the bar chart with custom legend labels
ggplot(summary_data, aes(x = Prevention.or.Literally.Homeless, y = Total.paid, fill = Prevention.or.Literally.Homeless)) +
  geom_bar(stat = "identity") +
  labs(title = "Majority of funding is spent on prevention of homelessness",
       x = "Prevention or Literally Homeless",
       y = "Total Paid") +
  scale_fill_discrete(name = "Prevention or Literally Homeless",
                      labels = c("Prevention" = "Prevention",
                                 "Literally Homeless" = "Literally Homeless"))



```

Secondary analysis

```{r, echo=FALSE, results='hide'}
#load data
solutions_fund <- X20231122_solutions_fund

#check data
head(solutions_fund)

#check data types
str(solutions_fund)

#convert to numeric
solutions_fund$Total.paid <- as.numeric(gsub("[\\$,]", "", solutions_fund$Total.paid))

library(stringr)

# Define categories and their respective regex patterns
categories <- c("Rent", "Utilities", "Applications", "Deposits", "Transportation")

# Define regex patterns for each category
patterns <- c(
  "(?i)rent",
  "(?i)utilities|electricity",
  "(?i)applications|apply",
  "(?i)deposits",
  "(?i)transportation|bus|taxi"
)

# Function to categorize based on patterns
categorize_category <- function(what_for) {
  for (i in seq_along(patterns)) {
    if (str_detect(what_for, patterns[i])) {
      return(categories[i])
    }
  }
  return("Other")
}

# Create a new column 'Category' based on similar words and patterns
solutions_fund <- solutions_fund %>%
  mutate(Category = sapply(What.for., categorize_category))

tail(solutions_fund)
#calculate the total paid by What for
total_paid_by_what_for <- solutions_fund %>%
  group_by(Category) %>%
  summarize(Total.paid = sum(Total.paid)) %>%
  mutate(Percent.of.Total = Total.paid / sum(Total.paid)) %>%
  mutate(Percent.of.Total = scales::percent(Percent.of.Total))
  
print(total_paid_by_what_for)

# Create the bar chart with custom legend labels
ggplot(total_paid_by_what_for, aes(x = Category, y = Total.paid, fill = Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Majority of funding is spent on prevention of homelessness",
       x = "What for",
       y = "Total Paid") +
  scale_fill_discrete(name = "What for",
                      labels = c("Prevention" = "Prevention",
                                 "Literally Homeless" = "Literally Homeless"))
```

### Evaluating the sources of funding and their impact on services provided

```{r, echo=FALSE, results='hide'}

# Load csv  file
df <- X20231122_solutions_fund

head(df)

#unique funding sources
unique(df$`Funding.Source`)

#convert to numeric
df$Total.paid <- as.numeric(gsub("[\\$,]", "", df$Total.paid))

# Calculate average spend per unique HMIS (patient number)
average_spend_per_HMIS <- df %>% 
  group_by(HMIS..) %>%
  summarise(AveragePaid = mean(Total.paid, na.rm = TRUE)) %>%
  arrange(desc(AveragePaid))

# Group by Funding.Source and summarize
average_spend_per_HMIS_by_source <- average_spend_per_HMIS %>% 
  left_join(df, by = "HMIS..") %>%
  group_by(`Funding.Source`) %>%
  summarise(AveragePaidBySource = mean(AveragePaid, na.rm = TRUE))

# Convert Funding.Source to ordered factor by AveragePaidBySource
average_spend_per_HMIS_by_source$`Funding.Source` <- factor(average_spend_per_HMIS_by_source$Funding.Source,
                                                            levels = average_spend_per_HMIS_by_source$Funding.Source[order(average_spend_per_HMIS_by_source$AveragePaidBySource, decreasing = TRUE)])

# Create a color scale based on the AveragePaidBySource values
color_scale <- scales::viridis_pal(option = "D")(length(unique(average_spend_per_HMIS_by_source$AveragePaidBySource)))

# Create the bar plot
ggplot(average_spend_per_HMIS_by_source, aes(x = `Funding.Source`, y = AveragePaidBySource, fill = AveragePaidBySource)) +
  geom_bar(stat = "identity") +
  scale_fill_gradient(low = color_scale[1], high = color_scale[length(color_scale)]) +
  labs(title = "Average Spend by Funding Source",
       x = "Funding Source",
       y = "Average Spend") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))



```

### Comparing demographics of those who are receiving funding to the overall population of those who are unhoused

Demographics of the people receiving funding compared to the overall MCES population

## Conclusion

insert conclusion
