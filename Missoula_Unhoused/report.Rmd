---
title: "Unhoused Funding Data Report"
author: "Tobin Haefele"
output:
  html_document:
    toc: yes
  word_document:
    toc: yes
---
## Introduction

In this report we partnered with the city of Missoula's "Community Planning, Development, and Innovation" (CPDI) department, specifically with the Community Development Division. In an effort to understand and monitor Missoula's unhoused population the CPDI department joined the Homeless Management Information System (HMIS) data collection effort by establishing a coordinated entry system. This allowed them to build datasets that can tell us much about the unhoused population. Along with this they have also executed a survey of the unhoused population to provide further data for us. Thanks to their hard work we have data to analyze and report on.

## Executive summary

The purpose of this report is to analyze the data provided by the CPDI department and provide a report on the findings. The report concluded with the following findings:

* Total amount spent, prevention vs currently homeless

* Funding sources and distribution of funding

* Demographics

```{r setup, echo=FALSE} 
knitr::opts_chunk$set(echo = FALSE)

```
  
```{r library, echo=FALSE, results='hide', message=FALSE}

# Load libraries
library(tidyverse)
library(lubridate)
library(ggplot2)
library(scales)
library(rmarkdown)
library(knitr)

#load data
X20231122_solutions_fund <- read.csv("C:/Users/thaef/OneDrive/Documents/GitHub/TSWD_Projects/Missoula_Unhoused/20231122-solutions-fund.csv")


```

### Analyzing the utilization of the housing solutions fund by prevention or currently homeless
Our first analysis is how the housing solutions fund is being utilized to help the unhoused population. We will look at the total amounnt of money spent on prevention and the total amount spent on those who are currently homeless. Along with this we also want to look at what the funding is being used for and how much is being used in each category.

Initial analysis of the housing solutions fund found that a total of $193,628 was put towards either prevention or assistance to those currently unhoused. Of this total around 77% of the funding is being used for prevention of homelessness compared to 23% being allocated for those who are currently homeless. This disparity could be explained by the fact that it is much cheaper to prevent homelessness than it is to assist those who are currently homeless. This also aligns with the CPDI's goal of preventing homelessness before it happens.

```{r, echo=FALSE, results='hide'}

#load data
solutions_fund <- X20231122_solutions_fund

#check data
head(solutions_fund)

#check data types
str(solutions_fund)

#summary statistics
summary(solutions_fund)

#convert to numeric
solutions_fund$Total.paid <- as.numeric(gsub("[\\$,]", "", solutions_fund$Total.paid))

# Calculate Total.paid and Percent.of.Total
summary_data <- solutions_fund %>%
  group_by(Prevention.or.Literally.Homeless) %>%
  summarize(Total.paid = sum(Total.paid)) %>%
  mutate(Percent.of.Total = Total.paid / sum(Total.paid)) %>%
  mutate(Percent.of.Total = scales::percent(Percent.of.Total))
print(summary_data)
print(sum(summary_data$Total.paid))


# Create the bar chart with custom legend labels
ggplot(summary_data, aes(x = Prevention.or.Literally.Homeless, y = Total.paid, fill = Prevention.or.Literally.Homeless)) +
  geom_bar(stat = "identity") +
  labs(title = "Majority of funding is spent on prevention of homelessness",
       x = "Prevention or Literally Homeless",
       y = "Total Paid") +
  scale_fill_discrete(name = "Prevention or Literally Homeless",
                      labels = c("Prevention" = "Prevention",
                                 "Literally Homeless" = "Literally Homeless"))



```

In this section I want to take a look at funding and how much is being spent on each category. This will allow us to view what the funding is being used for and how much is being spent on each category, allowing us to see if the funding is being used in the most optimal way.

Within the Prevention group we can see that the over 70% of funding is going towards rent while deposits make up around 14%. The makeup of these categories make sense as preventing eviction or helping with deposits to secure a place to live is a great way to prevent homelessness.

Among those currently homeless the majority of funding is going toward deposits (28%) and transportation (23%), both of these categories support the idea of helping those who are homeless either get into a home or get somewhere they have family/friends or a better opportunity.

```{r, echo=FALSE, message=FALSE}

#load data
solutions_fund <- X20231122_solutions_fund

#convert to numeric
solutions_fund$Total.paid <- as.numeric(gsub("[\\$,]", "", solutions_fund$Total.paid))

library(stringr)

# Define categories and their respective regex patterns
categories <- c("Rent", "Utilities", "Applications", "Deposits", "Transportation")

# Define regex patterns for each category
patterns <- c(
  "(?i)\\brent\\b",  # Matches "rent" as a whole word
  "(?i)utility|electricity|water",  # Includes common utilities
  "(?i)applications|apply|fee|fees",  # Matches application-related terms
  "(?i)deposit",  # Matches terms related to deposits
  "(?i)transportation|bus|taxi|gas"  # Matches transportation-related terms
)

# Function to categorize based on patterns
categorize_category <- function(what_for) {
  for (i in seq_along(patterns)) {
    if (str_detect(what_for, patterns[i])) {
      return(categories[i])
    }
  }
  return("Other")
}

# Create a new column 'Category' based on similar words and patterns
solutions_fund <- solutions_fund %>%
  mutate(Category = sapply(What.for., categorize_category))

# Calculate the total spent for each 'Prevention.or.Literally.Homeless' group
total_spent_by_group <- solutions_fund %>%
  group_by(Prevention.or.Literally.Homeless,Category) %>%
  summarise(TotalSpent = sum(Total.paid)) %>%
  mutate(percent_total = TotalSpent / sum(TotalSpent) * 100)

# Generate tables for each 'Prevention.or.Literally.Homeless' group
prevention_table <- total_spent_by_group %>%
  filter(Prevention.or.Literally.Homeless == "Prevention") %>%
  arrange(desc(TotalSpent))

literally_homeless_table <- total_spent_by_group %>%
  filter(Prevention.or.Literally.Homeless == "Literally Homeless") %>%
  arrange(desc(TotalSpent)) 

# Format columns for dollars and percentages
prevention_table$TotalSpent <- scales::dollar(prevention_table$TotalSpent)
prevention_table$percent_total <- scales::percent(prevention_table$percent_total / 100)

literally_homeless_table$TotalSpent <- scales::dollar(literally_homeless_table$TotalSpent)
literally_homeless_table$percent_total <- scales::percent(literally_homeless_table$percent_total / 100)

#knit the tables
knitr::kable(prevention_table, format = "markdown")
knitr::kable(literally_homeless_table, format = "markdown")

#plot
ggplot(total_spent_by_group, aes(x = Prevention.or.Literally.Homeless, y = percent_total, fill = Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Where the funding is being spent for prevention vs those currently homeless",
       x = "Category",
       y = "Percent of Total") +
  scale_fill_discrete(name = "Type of Assistance") +
  geom_text(aes(label = scales::percent(percent_total / 100, accuracy = 0.1)), 
            position = position_stack(vjust = 0.5)) +  # Position the text in the middle of each stack
  theme_minimal()

```

### Evaluating the sources of funding and their impact on services provided

In this next section we will take a look at where this funding is coming in from and how much is coming from each source. Using this data we can identify which sources are being utilized the most and which are being utilized the least.

Looking at the initial table we can see that just over half of the funding is coming from AHTF (Affordable Housing Trust Fund (City)) which is double the next closest source of funding OBT (Otto Bremer Trust) at 22%. Despite the EFSG (Emergency Solutions Grant (Human Resource Council program)) having a higher average spend on each individual at $762 per individual, this could be contributed to having a very small sample size of 10 individuals. The highest average spend on each individual when accounting for sample size ends up being the AHTF and WF (Wells Fargo) sources, at $559 and $529 respectively.

```{r, echo=FALSE, results='hide', message=FALSE}
```{r, echo=FALSE}

# Load csv  file
df <- X20231122_solutions_fund

#convert to numeric
df$Total.paid <- as.numeric(gsub("[\\$,]", "", df$Total.paid))

# Calculate average spend per unique HMIS (patient number)
average_spend_per_HMIS <- df %>% 
  group_by(HMIS..) %>%
  summarise(AveragePaid = mean(Total.paid, na.rm = TRUE)) %>%
  arrange(desc(AveragePaid))

# Group by Funding.Source and summarize
average_spend_per_HMIS_by_source <- average_spend_per_HMIS %>% 
  left_join(df, by = "HMIS..") %>%
  group_by(`Funding.Source`) %>%
  summarise(AveragePaidBySource = mean(AveragePaid, na.rm = TRUE))

#calculate number of unique HMIS per source
unique_HMIS_per_source <- df %>%
  group_by(`Funding.Source`) %>%
  summarise(Number_of_HMIS_Assisted = n_distinct(HMIS..))

# Convert Funding.Source to ordered factor by AveragePaidBySource
average_spend_per_HMIS_by_source$`Funding.Source` <- factor(average_spend_per_HMIS_by_source$Funding.Source,
                                                            levels = average_spend_per_HMIS_by_source$Funding.Source[order(average_spend_per_HMIS_by_source$AveragePaidBySource, decreasing = TRUE)])

# Create a color scale based on the AveragePaidBySource values
color_scale <- scales::viridis_pal(option = "D")(length(unique(average_spend_per_HMIS_by_source$AveragePaidBySource)))

#create table with total paid by source and the percent of total
total_paid_by_source <- df %>%
  group_by(`Funding.Source`) %>%
  summarise(TotalPaid = sum(Total.paid)) %>%
  mutate(PercentTotal = TotalPaid / sum(TotalPaid) * 100)

# Merge the two tables by Funding.Source
combined_table <- merge(total_paid_by_source, unique_HMIS_per_source, by = "Funding.Source")


# Format columns for dollars and percentages
combined_table$TotalPaid <- scales::dollar(combined_table$TotalPaid)
combined_table$PercentTotal <- scales::percent(combined_table$PercentTotal / 100)

#knit the table
knitr::kable(combined_table, format = "markdown", caption = "Overall Breakdown of Where Funding is Coming From")

# Create the bar plot
ggplot(average_spend_per_HMIS_by_source, aes(x = `Funding.Source`, y = AveragePaidBySource)) +
  geom_bar(stat = "identity") +
  scale_fill_gradient(low = color_scale[1], high = color_scale[length(color_scale)]) +
  labs(title = "Average amount paid per person by Funding Source",
       x = "Funding Source",
       y = "Average Spend ($)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Taking a look at the categories in which the majority of funding goes for each source also sheds some insight into the goal for each source. For example 100% of the funding from the EFSG were dedicated to Rental Assistance, 

```{r, echo=FALSE, results='hide', message=FALSE}
# Group by Funding Source and Category, calculate total paid and percentage
total_paid_by_what_for_by_source <- solutions_fund %>%
  group_by(Funding.Source, Category) %>%
  summarize(Total.paid = sum(Total.paid)) %>%
  mutate(Percent.of.Total = Total.paid / sum(Total.paid))

# Arrange by Total Paid within each Category within each Funding Source
total_paid_by_what_for_by_source <- total_paid_by_what_for_by_source %>%
  arrange(Funding.Source, desc(Total.paid))

# Convert Funding.Source to a factor, sorting levels by Total Paid
total_paid_by_what_for_by_source$Funding.Source <- factor(
  total_paid_by_what_for_by_source$Funding.Source, 
  levels = unique(total_paid_by_what_for_by_source$Funding.Source[order(-total_paid_by_what_for_by_source$Total.paid)])
)

# Plot the stacked bar chart
ggplot(total_paid_by_what_for_by_source, aes(x = Funding.Source, y = Percent.of.Total, fill = Category)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Percentage of funding spent on different categories by source",
       x = "Funding Source",
       y = "Percentage of Total") +
  scale_fill_discrete(name = "What for",
                      labels = c("Prevention" = "Prevention",
                                 "Literally Homeless" = "Literally Homeless")) +
  geom_text(aes(label = scales::percent(Percent.of.Total, accuracy = 0.1)), 
            position = position_fill(vjust = 0.5)) +  
  theme_minimal() +
  scale_y_continuous(labels = scales::percent_format(scale = 100))
  
```
  
```{r, echo=FALSE, results='hide', message=FALSE}
### Funding by source and referral from
library(plotrix)
library(ggplot2)

#import data
solutions_fund <- X20231122_solutions_fund

#convert to numeric
solutions_fund$Total.paid <- as.numeric(gsub("[\\$,]", "", solutions_fund$Total.paid))

#remove any spaces in the referral from column
solutions_fund$Referral.from <- gsub(" ", "", solutions_fund$Referral.from)

#convert all referral from to upper case
solutions_fund$Referral.from <- toupper(solutions_fund$Referral.from)
unique(solutions_fund$Referral.from)

# Calculate the total paid for each Referral from
total_paid_by_referral <- solutions_fund %>%
  group_by(Referral.from) %>%
  summarize(TotalPaid = sum(Total.paid)) %>%
  arrange(desc(TotalPaid))

# Select the top 5 referral forms based on total paid
top_5_referral_forms <- total_paid_by_referral %>%
  top_n(5, TotalPaid) %>%
  pull(Referral.from)

# Filter the data to retain only the top 5 referral forms
filtered_data <- solutions_fund %>%
  filter(Referral.from %in% top_5_referral_forms)

# Create a bubble chart
ggplot(filtered_data, aes(x = Funding.Source, y = Referral.from, size = Total.paid, color = Referral.from)) +
  geom_point(alpha = 0.6) +
  scale_size(range = c(3, 15)) +
  labs(title = "Top 5 Referral Forms by Funding Source and Total Paid",
       x = "Funding Source",
       y = "Referral from",
       size = "Total Paid",
       color = "Referral from") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Comparing demographics of those who are receiving funding to the overall population of those who are unhoused
```{r, echo=FALSE}
#load data
solutions_fund <- X20231122_solutions_fund

#convert to numeric
solutions_fund$Total.paid <- as.numeric(gsub("[\\$,]", "", solutions_fund$Total.paid))

#remove spaces
solutions_fund$Race <- gsub(" ", "", solutions_fund$Race)

# Consolidate categories for Race
solutions_fund <- solutions_fund %>%
  mutate(Race_Consolidated = case_when(
    Race %in% c("White") ~ "White",
    Race %in% c("NativeAmerican", "NativeAmerican/White", "American Indian, Alaska Native, or Indigenous") ~ "American Indian, Alaska Native, or Indigenous",
    grepl("Black", Race) ~ "Black, African American, or African", # Retaining the Black category
    Race %in% c("PacificIslander", "AsianAmerican/White") ~ "Asian American/Pacific Islander",
    TRUE ~ "Multiple" # Any other categories not specified
  ))


# Filter out rows where 'Race' is not blank
filtered_data <- solutions_fund %>%
  filter(!is.na(Race) & Race != "")

# Calculate the total paid amount across all races
total_paid_all_races <- sum(filtered_data$Total.paid)

# Group by Race_Consolidated, calculate frequency, total paid, average paid, and percent of total
race_summary <- filtered_data %>%
  group_by(Race_Consolidated) %>%
  summarise(
    Frequency = n(),
    TotalPaid = sum(Total.paid),
    AveragePaid = mean(Total.paid),
    PercentTotal = (TotalPaid / total_paid_all_races) * 100
  ) %>%
  arrange(desc(TotalPaid))

# Format columns for dollars and percentages
race_summary$TotalPaid <- scales::dollar(race_summary$TotalPaid)
race_summary$AveragePaid <- scales::dollar(race_summary$AveragePaid)
race_summary$PercentTotal <- scales::percent(race_summary$PercentTotal / 100)

knitr::kable(race_summary, format = "markdown")
```
Demographics of the people receiving funding compared to the overall MCES population
```{r, echo=FALSE}
##import mces data to compare
mces <- read.csv("C:/Users/thaef/OneDrive/Documents/GitHub/TSWD_Projects/Missoula_Unhoused/20231122-mces-data.csv")

filtered_data <- mces %>%
  mutate(
    Race_Consolidated = case_when(
      Race.and.Ethnicity %in% c("White") ~ "White",
      Race.and.Ethnicity %in% c("NativeAmerican", "NativeAmerican/White", "American Indian, Alaska Native, or Indigenous") ~ "American Indian, Alaska Native, or Indigenous",
      grepl("(?i)Black|Black, African American, or African", Race.and.Ethnicity, perl = TRUE) ~ "Black, African American, or African",
      grepl("(?i)Asian|Pacific Islander", Race.and.Ethnicity, perl = TRUE) ~ "Asian American/Pacific Islander",
      grepl(";", Race.and.Ethnicity) ~ "Multiple",
      grepl("(?i)Hispanic/Latina/e/o", Race.and.Ethnicity, perl = TRUE) ~ "Hispanic/Latina/e/o",
      TRUE ~ "Other"
    )
  )

# Calculate the total number of entries
total_entries <- filtered_data %>%
  filter(Race_Consolidated != "Other") %>%
  nrow()

# Group by Race_Consolidated and calculate frequency and percent of total
race_freq_table <- filtered_data %>%
  filter(Race_Consolidated != "Other") %>%
  group_by(Race_Consolidated) %>%
  summarise(
    Frequency = n(),
    PercentTotal = (n() / total_entries) * 100
  ) %>%
  arrange(desc(Frequency))

knitr::kable(race_freq_table, format = "markdown")
```
  
```{r, echo=FALSE}
#analyzing the amount of money going to those new to missoula vs those who have been here for a while

#load data
solutions_fund <- X20231122_solutions_fund

#convert to numeric
solutions_fund$Total.paid <- as.numeric(gsub("[\\$,]", "", solutions_fund$Total.paid))

#filter out rows where 6 mos in missoula is blank
filtered_data <- solutions_fund %>%
  filter(!is.na(X6.mos.in.Missoula...Y.N.) & X6.mos.in.Missoula...Y.N. != "")

#combine rows where 6 mos in missoula is N or no
filtered_data <- filtered_data %>%
  mutate(X6.mos.in.Missoula...Y.N. = case_when(
    X6.mos.in.Missoula...Y.N. %in% c("N", "No") ~ "N",
    TRUE ~ "Y"
  ))

#GRoup average paid by 6 mos in Missoula Y/N
average_paid_by_6_mos <- filtered_data %>%
  group_by(X6.mos.in.Missoula...Y.N.) %>%
  summarize(AveragePaid = mean(Total.paid, na.rm = TRUE)) %>%
  arrange(desc(AveragePaid))

# Create a color scale based on the AveragePaid values
color_scale <- scales::viridis_pal(option = "D")(length(unique(average_paid_by_6_mos$AveragePaid)))

# Create the bar plot
ggplot(average_paid_by_6_mos, aes(x = X6.mos.in.Missoula...Y.N., y = AveragePaid, fill = AveragePaid)) +
  geom_bar(stat = "identity") +
  scale_fill_gradient(low = color_scale[1], high = color_scale[length(color_scale)]) +
  labs(title = "Average Spend by 6 mos in Missoula Y/N",
       x = "6 mos in Missoula Y/N",
       y = "Average Spend") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#is the difference statistically significant?

```

### Conclusion

insert conclusion
